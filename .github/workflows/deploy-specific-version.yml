name: Rollback ECS Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'ë°°í¬í•  ì„œë¹„ìŠ¤ ì„ íƒ'
        required: true
        type: choice
        options:
          - api-user
          - api-admin
          - both
      ecr_tag:
        description: 'ë°°í¬í•  ECR íƒœê·¸ (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì—ì„œ ë³µì‚¬)'
        required: true
        type: string
      reason:
        description: 'ë²„ì „ ë³€ê²½ ì‚¬ìœ '
        required: true
        type: string
      deployment_type:
        description: 'ë°°í¬ ìœ í˜•'
        required: true
        type: choice
        options:
          - rollback
          - rollforward
          - hotfix
          - manual

permissions:
  contents: write
  issues: write

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.service }}
    runs-on: ubuntu-latest
    outputs:
      rollback-success: ${{ steps.wait-deployment.outputs.success }}
      user-rollback-performed: ${{ steps.rollback-status.outputs.user_rollback }}
      admin-rollback-performed: ${{ steps.rollback-status.outputs.admin_rollback }}
      user-previous-tag: ${{ steps.get-previous-versions.outputs.user-tag }}
      admin-previous-tag: ${{ steps.get-previous-versions.outputs.admin-tag }}
    steps:
      # ë¡¤ë°± ì „ í˜„ì¬ ë²„ì „ ì €ì¥
      - name: Get previous versions
        id: get-previous-versions
        run: |
          echo "ğŸ“Š ë¡¤ë°± ì „ ë²„ì „ í™•ì¸ ì¤‘..."
          
          # AWS ì¸ì¦
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region ${{ env.AWS_REGION }}
          
          # api-user í˜„ì¬ ë²„ì „
          USER_TASK_DEF=$(aws ecs describe-services \
            --cluster mini-shopping-cluster \
            --services api-user-service \
            --query 'services[0].taskDefinition' \
            --output text)
          
          USER_IMAGE=$(aws ecs describe-task-definition \
            --task-definition $USER_TASK_DEF \
            --query 'taskDefinition.containerDefinitions[0].image' \
            --output text)
          
          USER_TAG=$(echo $USER_IMAGE | awk -F':' '{print $NF}')
          echo "user-tag=$USER_TAG" >> $GITHUB_OUTPUT
          
          # api-admin í˜„ì¬ ë²„ì „
          ADMIN_TASK_DEF=$(aws ecs describe-services \
            --cluster mini-shopping-cluster \
            --services api-admin-service \
            --query 'services[0].taskDefinition' \
            --output text)
          
          ADMIN_IMAGE=$(aws ecs describe-task-definition \
            --task-definition $ADMIN_TASK_DEF \
            --query 'taskDefinition.containerDefinitions[0].image' \
            --output text)
          
          ADMIN_TAG=$(echo $ADMIN_IMAGE | awk -F':' '{print $NF}')
          echo "admin-tag=$ADMIN_TAG" >> $GITHUB_OUTPUT

      # AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ì´ë¯¸ì§€ í™•ì¸ ë° ë¡¤ë°± ì‹¤í–‰
      - name: Execute rollback
        run: |
          # ë¡¤ë°± ìˆ˜í–‰ ì¶”ì  í”Œë˜ê·¸ - ì–¸ë”ìŠ¤ì½”ì–´ ì‚¬ìš©
          USER_ROLLBACK_DONE="false"
          ADMIN_ROLLBACK_DONE="false"
          
          # api-user ë¡¤ë°±
          if [[ "${{ github.event.inputs.service }}" == "api-user" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            echo "ğŸ”„ api-user ë¡¤ë°± ì¤‘..."
          
            # í˜„ì¬ íƒœê·¸ì™€ ë¡¤ë°± íƒœê·¸ê°€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì‹¤ì œ ë¡¤ë°± ìˆ˜í–‰
            if [[ "${{ steps.get-previous-versions.outputs.user-tag }}" != "${{ github.event.inputs.ecr_tag }}" ]]; then
              # ì´ë¯¸ì§€ í™•ì¸
              aws ecr describe-images \
                --repository-name mini-shopping/api-user \
                --image-ids imageTag=${{ github.event.inputs.ecr_tag }} || exit 1
          
              # íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
              aws ecs describe-task-definition \
                --task-definition api-user-task \
                --query taskDefinition > task-def.json
          
              jq '.containerDefinitions[0].image = "${{ steps.login-ecr.outputs.registry }}/mini-shopping/api-user:${{ github.event.inputs.ecr_tag }}"' \
                task-def.json | \
              jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .enableFaultInjection)' \
                > new-task-def.json
          
              TASK_ARN=$(aws ecs register-task-definition \
                --cli-input-json file://new-task-def.json \
                --query 'taskDefinition.taskDefinitionArn' \
                --output text)
          
              aws ecs update-service \
                --cluster mini-shopping-cluster \
                --service api-user-service \
                --task-definition $TASK_ARN \
                --force-new-deployment
          
              USER_ROLLBACK_DONE="true"
            else
              echo "â­ï¸ api-userëŠ” ì´ë¯¸ ëŒ€ìƒ ë²„ì „ì…ë‹ˆë‹¤. ë¡¤ë°±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo "ğŸ’¡ ë™ì¼ ë²„ì „ ì¬ë°°í¬ê°€ í•„ìš”í•œ ê²½ìš° ì¬ë°°í¬ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
            fi
          fi
          
          # api-admin ë¡¤ë°±
          if [[ "${{ github.event.inputs.service }}" == "api-admin" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            echo "ğŸ”„ api-admin ë¡¤ë°± ì¤‘..."
          
            # í˜„ì¬ íƒœê·¸ì™€ ë¡¤ë°± íƒœê·¸ê°€ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ì‹¤ì œ ë¡¤ë°± ìˆ˜í–‰
            if [[ "${{ steps.get-previous-versions.outputs.admin-tag }}" != "${{ github.event.inputs.ecr_tag }}" ]]; then
              # ì´ë¯¸ì§€ í™•ì¸
              aws ecr describe-images \
                --repository-name mini-shopping/api-admin \
                --image-ids imageTag=${{ github.event.inputs.ecr_tag }} || exit 1
          
              # íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
              aws ecs describe-task-definition \
                --task-definition api-admin-task \
                --query taskDefinition > task-def.json
          
              jq '.containerDefinitions[0].image = "${{ steps.login-ecr.outputs.registry }}/mini-shopping/api-admin:${{ github.event.inputs.ecr_tag }}"' \
                task-def.json | \
              jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .enableFaultInjection)' \
                > new-task-def.json
          
              TASK_ARN=$(aws ecs register-task-definition \
                --cli-input-json file://new-task-def.json \
                --query 'taskDefinition.taskDefinitionArn' \
                --output text)
          
              aws ecs update-service \
                --cluster mini-shopping-cluster \
                --service api-admin-service \
                --task-definition $TASK_ARN \
                --force-new-deployment
          
              ADMIN_ROLLBACK_DONE="true"
            else
              echo "â­ï¸ api-adminì€ ì´ë¯¸ ëŒ€ìƒ ë²„ì „ì…ë‹ˆë‹¤. ë¡¤ë°±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              echo "ğŸ’¡ ë™ì¼ ë²„ì „ ì¬ë°°í¬ê°€ í•„ìš”í•œ ê²½ìš° ì¬ë°°í¬ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”."
            fi
          fi
          
          # ë¡¤ë°± ìˆ˜í–‰ ê²°ê³¼ë¥¼ íŒŒì¼ì— ì €ì¥ - ë³€ìˆ˜ëª…ì— ì–¸ë”ìŠ¤ì½”ì–´ ì‚¬ìš©
          echo "user_rollback=$USER_ROLLBACK_DONE" >> rollback-status.txt
          echo "admin_rollback=$ADMIN_ROLLBACK_DONE" >> rollback-status.txt

      # ë¡¤ë°± ìƒíƒœ ì½ê¸° - ìˆ˜ì •ëœ ë³€ìˆ˜ëª… ì‚¬ìš©
      - name: Read rollback status
        id: rollback-status
        run: |
          if [ -f rollback-status.txt ]; then
            # source ëª…ë ¹ì–´ë¡œ íŒŒì¼ ì½ê¸° - ì´ì œ ë³€ìˆ˜ëª…ì´ ì˜¬ë°”ë¥´ë¯€ë¡œ ì˜¤ë¥˜ ì—†ìŒ
            source rollback-status.txt
            echo "user_rollback=${user_rollback}" >> $GITHUB_OUTPUT
            echo "admin_rollback=${admin_rollback}" >> $GITHUB_OUTPUT
          else
            echo "user_rollback=false" >> $GITHUB_OUTPUT
            echo "admin_rollback=false" >> $GITHUB_OUTPUT
          fi

      # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
      - name: Wait for deployment
        id: wait-deployment
        run: |
          echo "â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          
          wait_for_service() {
            local service=$1
            local max_attempts=40
            local attempt=0
          
            while [ $attempt -lt $max_attempts ]; do
              ROLLOUT_STATE=$(aws ecs describe-services \
                --cluster mini-shopping-cluster \
                --services $service \
                --query 'services[0].deployments[0].rolloutState' \
                --output text)
          
              if [ "$ROLLOUT_STATE" == "COMPLETED" ]; then
                echo "âœ… $service ë°°í¬ ì™„ë£Œ"
                return 0
              elif [ "$ROLLOUT_STATE" == "FAILED" ]; then
                echo "âŒ $service ë°°í¬ ì‹¤íŒ¨"
                return 1
              fi
          
              sleep 15
              ((attempt++))
            done
            return 1
          }
          
          SUCCESS="true"
          
          # ì‹¤ì œë¡œ ë¡¤ë°±ì´ ìˆ˜í–‰ëœ ì„œë¹„ìŠ¤ë§Œ ëŒ€ê¸°
          if [[ "${{ steps.rollback-status.outputs.user_rollback }}" == "true" ]]; then
            wait_for_service "api-user-service" || SUCCESS="false"
          fi
          
          if [[ "${{ steps.rollback-status.outputs.admin_rollback }}" == "true" ]]; then
            wait_for_service "api-admin-service" || SUCCESS="false"
          fi
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT

  # ë¡¤ë°± í›„ ìƒˆ ë¦´ë¦¬ì¦ˆ ìƒì„± (í˜„ì¬ ìš´ì˜ ë²„ì „ ë°˜ì˜)
  create-current-release:
    name: Create Current State Release
    needs: rollback
    if: needs.rollback.outputs.rollback-success == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ë²„ì „ ì •ë³´ ë° íƒœìŠ¤í¬ ê°œìˆ˜ ìˆ˜ì§‘
      - name: Get current running versions and task counts
        id: current-versions
        run: |
          echo "ğŸ“Š í˜„ì¬ ìš´ì˜ ë²„ì „ ë° íƒœìŠ¤í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # api-user í˜„ì¬ ì •ë³´
          USER_SERVICE_INFO=$(aws ecs describe-services \
            --cluster mini-shopping-cluster \
            --services api-user-service \
            --query 'services[0]' \
            --output json)
          
          USER_TASK_DEF=$(echo $USER_SERVICE_INFO | jq -r '.taskDefinition')
          USER_RUNNING_COUNT=$(echo $USER_SERVICE_INFO | jq -r '.runningCount')
          USER_DESIRED_COUNT=$(echo $USER_SERVICE_INFO | jq -r '.desiredCount')
          
          USER_IMAGE=$(aws ecs describe-task-definition \
            --task-definition $USER_TASK_DEF \
            --query 'taskDefinition.containerDefinitions[0].image' \
            --output text)
          
          USER_TAG=$(echo $USER_IMAGE | awk -F':' '{print $NF}')
          USER_DIGEST=$(aws ecr describe-images \
            --repository-name mini-shopping/api-user \
            --image-ids imageTag=$USER_TAG \
            --query 'imageDetails[0].imageDigest' \
            --output text || echo "N/A")
          
          echo "api-user-tag=$USER_TAG" >> $GITHUB_OUTPUT
          echo "api-user-digest=$USER_DIGEST" >> $GITHUB_OUTPUT
          echo "api-user-running=$USER_RUNNING_COUNT" >> $GITHUB_OUTPUT
          echo "api-user-desired=$USER_DESIRED_COUNT" >> $GITHUB_OUTPUT
          
          echo "âœ… api-user í˜„ì¬ ìƒíƒœ:"
          echo "   - ë²„ì „: $USER_TAG"
          echo "   - ì‹¤í–‰ ì¤‘: $USER_RUNNING_COUNT / ì›í•˜ëŠ” ìˆ˜: $USER_DESIRED_COUNT"
          
          # api-admin í˜„ì¬ ì •ë³´
          ADMIN_SERVICE_INFO=$(aws ecs describe-services \
            --cluster mini-shopping-cluster \
            --services api-admin-service \
            --query 'services[0]' \
            --output json)
          
          ADMIN_TASK_DEF=$(echo $ADMIN_SERVICE_INFO | jq -r '.taskDefinition')
          ADMIN_RUNNING_COUNT=$(echo $ADMIN_SERVICE_INFO | jq -r '.runningCount')
          ADMIN_DESIRED_COUNT=$(echo $ADMIN_SERVICE_INFO | jq -r '.desiredCount')
          
          ADMIN_IMAGE=$(aws ecs describe-task-definition \
            --task-definition $ADMIN_TASK_DEF \
            --query 'taskDefinition.containerDefinitions[0].image' \
            --output text)
          
          ADMIN_TAG=$(echo $ADMIN_IMAGE | awk -F':' '{print $NF}')
          ADMIN_DIGEST=$(aws ecr describe-images \
            --repository-name mini-shopping/api-admin \
            --image-ids imageTag=$ADMIN_TAG \
            --query 'imageDetails[0].imageDigest' \
            --output text || echo "N/A")
          
          echo "api-admin-tag=$ADMIN_TAG" >> $GITHUB_OUTPUT
          echo "api-admin-digest=$ADMIN_DIGEST" >> $GITHUB_OUTPUT
          echo "api-admin-running=$ADMIN_RUNNING_COUNT" >> $GITHUB_OUTPUT
          echo "api-admin-desired=$ADMIN_DESIRED_COUNT" >> $GITHUB_OUTPUT
          
          echo "âœ… api-admin í˜„ì¬ ìƒíƒœ:"
          echo "   - ë²„ì „: $ADMIN_TAG"
          echo "   - ì‹¤í–‰ ì¤‘: $ADMIN_RUNNING_COUNT / ì›í•˜ëŠ” ìˆ˜: $ADMIN_DESIRED_COUNT"

      # í˜„ì¬ ì‹œê°„
      - name: Get current date
        id: date
        run: |
          echo "date=$(TZ=Asia/Seoul date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "timestamp=$(TZ=Asia/Seoul date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # ìƒˆ ë¦´ë¦¬ì¦ˆ ìƒì„± (í˜„ì¬ ìš´ì˜ ìƒíƒœ ë°˜ì˜)
      - name: Create new release with current state
        uses: softprops/action-gh-release@v2
        with:
          tag_name: rollback-${{ steps.date.outputs.timestamp }}
          name: Rollback ${{ github.run_number }}
          body: |
            ## ğŸ”„ ë¡¤ë°± ì™„ë£Œ
            
            ### ë¡¤ë°± ì •ë³´
            - **ë¡¤ë°± ì‹œê°„:** ${{ steps.date.outputs.datetime }} (KST)
            - **ë¡¤ë°± ëŒ€ìƒ:** ${{ github.event.inputs.service }}
            - **ë¡¤ë°± ì‚¬ìœ :** ${{ github.event.inputs.reason }}
            - **ìš”ì²­ëœ ë²„ì „:** `${{ github.event.inputs.ecr_tag }}`
            
            ### í˜„ì¬ ìš´ì˜ ë²„ì „
            - **api-user:** ${{ needs.rollback.outputs.user-rollback-performed == 'true' && 'ğŸ”„ ë¡¤ë°±ë¨' || 'âœ… ë³€ê²½ ì—†ìŒ' }}
              - ì´ì „ ë²„ì „: `${{ needs.rollback.outputs.user-previous-tag }}`
              - í˜„ì¬ ë²„ì „: `${{ steps.current-versions.outputs.api-user-tag }}`
              - **ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬:** ${{ steps.current-versions.outputs.api-user-running }} / ${{ steps.current-versions.outputs.api-user-desired }}
              - Digest: `${{ steps.current-versions.outputs.api-user-digest }}`
            
            - **api-admin:** ${{ needs.rollback.outputs.admin-rollback-performed == 'true' && 'ğŸ”„ ë¡¤ë°±ë¨' || 'âœ… ë³€ê²½ ì—†ìŒ' }}
              - ì´ì „ ë²„ì „: `${{ needs.rollback.outputs.admin-previous-tag }}`
              - í˜„ì¬ ë²„ì „: `${{ steps.current-versions.outputs.api-admin-tag }}`
              - **ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬:** ${{ steps.current-versions.outputs.api-admin-running }} / ${{ steps.current-versions.outputs.api-admin-desired }}
              - Digest: `${{ steps.current-versions.outputs.api-admin-digest }}`
            
            ### ì‹¤í–‰ ì •ë³´
            - **ì‹¤í–‰ì:** @${{ github.actor }}
            - **ë°°í¬ í™˜ê²½:** Production
            - **Actions ë§í¬:** [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            > âš ï¸ **ì£¼ì˜**: ì´ ë¦´ë¦¬ì¦ˆëŠ” ë¡¤ë°± ì‘ì—…ì˜ ê²°ê³¼ì…ë‹ˆë‹¤. í˜„ì¬ ìš´ì˜ ì¤‘ì¸ ë²„ì „ì„ ì •í™•íˆ ë°˜ì˜í•©ë‹ˆë‹¤.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ë¡¤ë°± ì´ìŠˆ ìƒì„±
  create-rollback-issue:
    name: Create Rollback Issue
    needs: [rollback, create-current-release]
    if: needs.rollback.outputs.rollback-success == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # í˜„ì¬ ì‹œê°„
      - name: Get current date
        id: date
        run: |
          echo "datetime=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # ì´ìŠˆ ìƒì„±
      - name: Create rollback issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = `ğŸ”„ ë¡¤ë°± ì™„ë£Œ: ${context.payload.inputs.service} - ${new Date().toISOString().split('T')[0]}`;
            
            let rollbackDetails = [];
            
            // ì‹¤ì œ ë¡¤ë°±ëœ ì„œë¹„ìŠ¤ë§Œ í‘œì‹œ
            if ('${{ needs.rollback.outputs.user-rollback-performed }}' === 'true') {
              rollbackDetails.push('- **api-user**: `${{ needs.rollback.outputs.user-previous-tag }}` â†’ `${{ github.event.inputs.ecr_tag }}`');
            }
            
            if ('${{ needs.rollback.outputs.admin-rollback-performed }}' === 'true') {
              rollbackDetails.push('- **api-admin**: `${{ needs.rollback.outputs.admin-previous-tag }}` â†’ `${{ github.event.inputs.ecr_tag }}`');
            }
            
            const issueBody = `## ë¡¤ë°± ìƒì„¸ ì •ë³´
            
            ### ê¸°ë³¸ ì •ë³´
            - **ë¡¤ë°± ì‹œê°„**: ${{ steps.date.outputs.datetime }} (KST)
            - **ë¡¤ë°± ì‹¤í–‰ì**: @${{ github.actor }}
            - **ë¡¤ë°± ëŒ€ìƒ**: ${{ github.event.inputs.service }}
            - **ë¡¤ë°± ì‚¬ìœ **: ${{ github.event.inputs.reason }}
            
            ### ë¡¤ë°±ëœ ì„œë¹„ìŠ¤
            ${rollbackDetails.length > 0 ? rollbackDetails.join('\n') : '- ì‹¤ì œ ë¡¤ë°±ëœ ì„œë¹„ìŠ¤ ì—†ìŒ (ì´ë¯¸ ëŒ€ìƒ ë²„ì „ì´ì—ˆìŒ)'}
            
            ### ê´€ë ¨ ë§í¬
            - [Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸](https://github.com/${{ github.repository }}/releases/latest)
            
            ### ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘ í™•ì¸
            - [ ] ëª¨ë‹ˆí„°ë§ ì§€í‘œ í™•ì¸
            - [ ] ê´€ë ¨ íŒ€ ê³µìœ  ì™„ë£Œ
            
            ---
            
            > ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['rollback', 'production', 'automated'],
              assignees: ['${{ github.actor }}']
            });
            
            console.log(`Issue created: ${issue.data.html_url}`);