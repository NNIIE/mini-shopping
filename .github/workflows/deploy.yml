name: Deploy to ECS

on:
  push:
    branches: [main]

permissions:
  contents: write   # Release, Tag ìƒì„± ë“±

env:
  JAVA_VERSION: '21'

jobs:
  # ë³€ê²½ì‚¬í•­ ê°ì§€
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api-user: ${{ steps.filter.outputs.api-user }}
      api-admin: ${{ steps.filter.outputs.api-admin }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµë¥¼ ìœ„í•´

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            api-user:
              - 'api-user/**'
              - 'storage/**'
              - 'support/**'
              - 'build.gradle'
              - 'settings.gradle'
            api-admin:
              - 'api-admin/**'
              - 'storage/**'
              - 'support/**'
              - 'build.gradle'
              - 'settings.gradle'

  # --- ë³‘ë ¬ ë°°í¬ ì‘ì—… ---

  # api-user ë°°í¬ (ë³€ê²½ì‹œì—ë§Œ)
  deploy-api-user:
    name: Build and Deploy api-user
    needs: detect-changes
    if: needs.detect-changes.outputs.api-user == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4  # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # api-user ëª¨ë“ˆë§Œ ë¹Œë“œ - Jar ìƒì„±, í…ŒìŠ¤íŠ¸ ìƒëµ(CI ë‹¨ê³„ì—ì„œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰)
      - name: Build api-user only
        run: ./gradlew :api-user:bootJar -x test

      # AWS ì¸ì¦ ì„¤ì • (IAM ì ‘ê·¼í‚¤, ì‹œí¬ë¦¿í‚¤)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      - name: Build and push api-user Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: mini-shopping/api-user
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f api-user/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # ê¸°ì¡´ ECS íƒœìŠ¤í¬ ì •ì˜ ë‚´ë ¤ë°›ê¸° (ë³€ê²½ ì¤€ë¹„)
      - name: Download current api-user task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition api-user-task \
            --query taskDefinition \
            | jq 'del(.enableFaultInjection)' > task-definition-user.json
          cat task-definition-user.json

      # ì´ë¯¸ì§€ íƒœê·¸ë§Œ ìƒˆ ê°’ìœ¼ë¡œ ë°”ê¿”ì„œ task definition ë Œë”ë§
      - name: Update api-user task definition
        id: task-def-user
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition-user.json
          container-name: api-user
          image: ${{ steps.login-ecr.outputs.registry }}/mini-shopping/api-user:${{ github.sha }}

      # ECS ì„œë¹„ìŠ¤ì— ì‹ ê·œ íƒœìŠ¤í¬ ì •ì˜ë¡œ ë°°í¬
      - name: Deploy api-user to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-user.outputs.task-definition }}
          service: api-user-service
          cluster: mini-shopping-cluster
          wait-for-service-stability: true

  # api-admin ë°°í¬ (ë³€ê²½ì‹œì—ë§Œ)
  deploy-api-admin:
    name: Build and Deploy api-admin
    needs: detect-changes
    if: needs.detect-changes.outputs.api-admin == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # api-admin ëª¨ë“ˆë§Œ ë¹Œë“œ - Jar ìƒì„±, í…ŒìŠ¤íŠ¸ ìƒëµ(CI ë‹¨ê³„ì—ì„œ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰)
      - name: Build api-admin only
        run: ./gradlew :api-admin:bootJar -x test

      # AWS ì¸ì¦ ì„¤ì • (IAM ì ‘ê·¼í‚¤, ì‹œí¬ë¦¿í‚¤)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
      - name: Build and push api-admin Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: mini-shopping/api-admin
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f api-admin/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      # ê¸°ì¡´ ECS íƒœìŠ¤í¬ ì •ì˜ ë‚´ë ¤ë°›ê¸° (ë³€ê²½ ì¤€ë¹„)
      - name: Download current api-admin task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition api-admin-task \
            --query taskDefinition \
            | jq 'del(.enableFaultInjection)' > task-definition-admin.json
          cat task-definition-admin.json

      # ì´ë¯¸ì§€ íƒœê·¸ë§Œ ìƒˆ ê°’ìœ¼ë¡œ ë°”ê¿”ì„œ task definition ë Œë”ë§
      - name: Update api-admin task definition
        id: task-def-admin
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition-admin.json
          container-name: api-admin
          image: ${{ steps.login-ecr.outputs.registry }}/mini-shopping/api-admin:${{ github.sha }}

      # ECS ì„œë¹„ìŠ¤ì— ì‹ ê·œ íƒœìŠ¤í¬ ì •ì˜ë¡œ ë°°í¬
      - name: Deploy api-admin to ECS
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-admin.outputs.task-definition }}
          service: api-admin-service
          cluster: mini-shopping-cluster
          wait-for-service-stability: true


# --- ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìë™ ìƒì„± Job ---
  create-release-note:
    name: Create Release Note
    runs-on: ubuntu-latest
    needs: [deploy-api-user, deploy-api-admin]
    if: |
      always() && (needs.deploy-api-user.result == 'success' || needs.deploy-api-admin.result == 'success')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (í•œêµ­ ì‹œê°„)
      - name: Get current date
        id: date
        run: |
          echo "date=$(TZ=Asia/Seoul date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "timestamp=$(TZ=Asia/Seoul date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # AWS ì¸ì¦ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # PR ì •ë³´ ì¶”ì¶œ (ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ)
      - name: Extract PR Info
        id: prinfo
        run: |
          # ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ PR ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: "Merge pull request #21")
          PR_NUMBER=$(echo "${{ github.event.head_commit.message }}" | grep -oP '#\K[0-9]+' | head -1)
          
          if [ ! -z "$PR_NUMBER" ]; then
            echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          
            # GitHub APIë¡œ PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            PR_INFO=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER)
            PR_TITLE=$(echo "$PR_INFO" | jq -r '.title')
            PR_AUTHOR=$(echo "$PR_INFO" | jq -r '.user.login')
          
            echo "title=$PR_TITLE" >> $GITHUB_OUTPUT
            echo "author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          else
            echo "number=" >> $GITHUB_OUTPUT
            echo "title=" >> $GITHUB_OUTPUT
            echo "author=" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ê³µí†µ ëª¨ë“ˆ(storage, support) ë³€ê²½ ê°ì§€
      - name: Detect if storage/support changed
        id: common_change
        run: |
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -qE '^storage/|^support/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      # ë³€ê²½ íŒŒì¼/ì»¤ë°‹ ë¡œê·¸ ì¶”ì¶œ
      - name: Generate changelog
        id: changelog
        run: |
          echo "log<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:'- %h %s (%an)' ${{ github.event.before }}..${{ github.sha }} >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ECR ì´ë¯¸ì§€ digest ì¶”ì¶œ (api-user)
      - name: Get image digest api-user
        id: digest_user
        if: needs.deploy-api-user.result == 'success'
        run: |
          digest=$(aws ecr describe-images --repository-name mini-shopping/api-user --image-ids imageTag=${{ github.sha }} --query 'imageDetails[0].imageDigest' --output text 2>/dev/null || echo "N/A")
          echo "digest=$digest" >> $GITHUB_OUTPUT

      # ECR ì´ë¯¸ì§€ digest ì¶”ì¶œ (api-admin)
      - name: Get image digest api-admin
        id: digest_admin
        if: needs.deploy-api-admin.result == 'success'
        run: |
          digest=$(aws ecr describe-images --repository-name mini-shopping/api-admin --image-ids imageTag=${{ github.sha }} --query 'imageDetails[0].imageDigest' --output text 2>/dev/null || echo "N/A")
          echo "digest=$digest" >> $GITHUB_OUTPUT

      # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸/ë¦´ë¦¬ì¦ˆ ìƒì„±
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: release-${{ steps.date.outputs.timestamp }}
          name: Release ${{ github.run_number }}
          body: |
            ## ğŸš€ ECS ë°°í¬ ì™„ë£Œ
            
            ### ë°°í¬ ì •ë³´
            - **ë°°í¬ ì‹œê°„:** ${{ steps.date.outputs.datetime }} (KST)
            - **ì»¤ë°‹ SHA:** ${{ github.sha }}
            
            ### ë°°í¬ ê²°ê³¼
            - **api-user:** ${{ needs.deploy-api-user.result == 'success' && 'âœ… ì„±ê³µ' || needs.deploy-api-user.result == 'skipped' && 'â­ï¸ ìŠ¤í‚µ' || 'âŒ ì‹¤íŒ¨' }}
              - ECR íƒœê·¸: `${{ github.sha }}`
              - Digest: `${{ steps.digest_user.outputs.digest }}`
            
            - **api-admin:** ${{ needs.deploy-api-admin.result == 'success' && 'âœ… ì„±ê³µ' || needs.deploy-api-admin.result == 'skipped' && 'â­ï¸ ìŠ¤í‚µ' || 'âŒ ì‹¤íŒ¨' }}
              - ECR íƒœê·¸: `${{ github.sha }}`
              - Digest: `${{ steps.digest_admin.outputs.digest }}`
            
            ### PR ì •ë³´
            - **PR ë²ˆí˜¸:** ${{ steps.prinfo.outputs.number && format('#{0}', steps.prinfo.outputs.number) || 'N/A' }}
            - **PR ì œëª©:** ${{ steps.prinfo.outputs.title || 'N/A' }}
            - **PR ì‘ì„±ì:** ${{ steps.prinfo.outputs.author || 'N/A' }}
            
            ### ë³€ê²½ ë‚´ì—­
            - **ê³µí†µ ëª¨ë“ˆ ë³€ê²½:** ${{ steps.common_change.outputs.changed == 'true' && 'ì˜ˆ' || 'ì•„ë‹ˆì˜¤' }}
            - **ì»¤ë°‹ ë©”ì‹œì§€:** ${{ github.event.head_commit.message }}
            
            <details>
            <summary>ğŸ“ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡</summary>
            
            ```
            ${{ steps.changelog.outputs.files }}
            ```
            </details>
            
            <details>
            <summary>ğŸ“ ì»¤ë°‹ ë¡œê·¸</summary>
            
            ```
            ${{ steps.changelog.outputs.log }}
            ```
            </details>
            
            ### ê¸°íƒ€ ì •ë³´
            - **ë¦´ë¦¬ì¦ˆ ì‘ì„±ì:** @${{ github.actor }}
            - **ë°°í¬ í™˜ê²½:** Production
            - **ì»¤ë°‹ ë§í¬:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            
            ---
            
            > ğŸ’¡ **ë¡¤ë°± ê°€ì´ë“œ**: ECR íƒœê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

