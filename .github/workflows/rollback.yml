name: Rollback ECS Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'ë¡¤ë°±í•  ì„œë¹„ìŠ¤ ì„ íƒ'
        required: true
        type: choice
        options:
          - api-user
          - api-admin
          - both
      commit_sha:
        description: 'ë¡¤ë°±í•  ì»¤ë°‹ SHA ë˜ëŠ” ECR íƒœê·¸ (ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ì—ì„œ ë³µì‚¬)'
        required: true
        type: string
        # ì˜ˆì‹œ: 01f2b7e8b443448e5989fe002854b74149076120
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string
        # ì˜ˆì‹œ: ë²„ê·¸ ë°œê²¬ìœ¼ë¡œ ì¸í•œ ê¸´ê¸‰ ë¡¤ë°±

# GitHub Actions ê¶Œí•œ ì„¤ì •
permissions:
  contents: read    # ì½”ë“œ ì½ê¸° ê¶Œí•œ
  issues: write     # ì´ìŠˆ ìƒì„± ê¶Œí•œ

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  rollback:
    name: Rollback ${{ github.event.inputs.service }}
    runs-on: ubuntu-latest
    steps:
      # Step 1: AWS ì¸ì¦ ì„¤ì •
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Step 2: ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Step 3: ë¡¤ë°± ì „ í˜„ì¬ ìƒíƒœ ê¸°ë¡
      - name: Log current state before rollback
        run: |
          echo "ğŸ“¸ ë¡¤ë°± ì „ í˜„ì¬ ìƒíƒœ ê¸°ë¡"
          echo "================================"
          
          # api-user í˜„ì¬ ìƒíƒœ
          if [[ "${{ github.event.inputs.service }}" == "api-user" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            echo "### api-user ì„œë¹„ìŠ¤ í˜„ì¬ ìƒíƒœ ###"
            aws ecs describe-services \
              --cluster mini-shopping-cluster \
              --services api-user-service \
              --query 'services[0].{TaskDefinition:taskDefinition,DesiredCount:desiredCount,RunningCount:runningCount}' \
              --output json
          fi
          
          # api-admin í˜„ì¬ ìƒíƒœ
          if [[ "${{ github.event.inputs.service }}" == "api-admin" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            echo "### api-admin ì„œë¹„ìŠ¤ í˜„ì¬ ìƒíƒœ ###"
            aws ecs describe-services \
              --cluster mini-shopping-cluster \
              --services api-admin-service \
              --query 'services[0].{TaskDefinition:taskDefinition,DesiredCount:desiredCount,RunningCount:runningCount}' \
              --output json
          fi

      # Step 4: ëŒ€ìƒ ì´ë¯¸ì§€ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Verify target image exists
        run: |
          echo "ğŸ” ë¡¤ë°± ëŒ€ìƒ ì´ë¯¸ì§€ í™•ì¸ ì¤‘..."
          
          # api-user ì´ë¯¸ì§€ í™•ì¸
          if [[ "${{ github.event.inputs.service }}" == "api-user" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            echo "Checking api-user image: ${{ github.event.inputs.commit_sha }}"
            aws ecr describe-images \
              --repository-name mini-shopping/api-user \
              --image-ids imageTag=${{ github.event.inputs.commit_sha }} \
              --query 'imageDetails[0].imagePushedAt' \
              --output text || { echo "âŒ api-user ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"; exit 1; }
          fi
          
          # api-admin ì´ë¯¸ì§€ í™•ì¸
          if [[ "${{ github.event.inputs.service }}" == "api-admin" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            echo "Checking api-admin image: ${{ github.event.inputs.commit_sha }}"
            aws ecr describe-images \
              --repository-name mini-shopping/api-admin \
              --image-ids imageTag=${{ github.event.inputs.commit_sha }} \
              --query 'imageDetails[0].imagePushedAt' \
              --output text || { echo "âŒ api-admin ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"; exit 1; }
          fi
          
          echo "âœ… ëŒ€ìƒ ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ"

      # Step 5: api-user ë¡¤ë°± ì‹¤í–‰
      - name: Rollback api-user
        if: github.event.inputs.service == 'api-user' || github.event.inputs.service == 'both'
        run: |
          echo "ğŸ”„ api-user ë¡¤ë°± ì‹œì‘..."
          
          # í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ë‹¤ìš´ë¡œë“œ
          aws ecs describe-task-definition \
            --task-definition api-user-task \
            --query taskDefinition > current-task-def.json
          
          # ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë¡¤ë°± ëŒ€ìƒìœ¼ë¡œ ë³€ê²½
          # jqë¥¼ ì‚¬ìš©í•˜ì—¬ JSON íŒŒì¼ì˜ ì´ë¯¸ì§€ URL ìˆ˜ì •
          jq '.containerDefinitions[0].image = "${{ steps.login-ecr.outputs.registry }}/mini-shopping/api-user:${{ github.event.inputs.commit_sha }}"' \
            current-task-def.json > new-task-def.json
          
          # ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±° (AWSì—ì„œ ìë™ ìƒì„±í•˜ëŠ” í•„ë“œë“¤)
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .enableFaultInjection)' \
            new-task-def.json > final-task-def.json
          
          # ìƒˆë¡œìš´ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          echo "ğŸ“ ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡ ì¤‘..."
          TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://final-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "âœ… ìƒˆ íƒœìŠ¤í¬ ì •ì˜: $TASK_ARN"
          
          # ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (ìƒˆ íƒœìŠ¤í¬ ì •ì˜ë¡œ ë°°í¬)
          echo "ğŸš€ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."
          aws ecs update-service \
            --cluster mini-shopping-cluster \
            --service api-user-service \
            --task-definition $TASK_ARN \
            --force-new-deployment
          
          echo "âœ… api-user ë¡¤ë°± ëª…ë ¹ ì™„ë£Œ (ë°°í¬ ì§„í–‰ ì¤‘)"

      # Step 6: api-admin ë¡¤ë°± ì‹¤í–‰
      - name: Rollback api-admin
        if: github.event.inputs.service == 'api-admin' || github.event.inputs.service == 'both'
        run: |
          echo "ğŸ”„ api-admin ë¡¤ë°± ì‹œì‘..."
          
          # í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ë‹¤ìš´ë¡œë“œ
          aws ecs describe-task-definition \
            --task-definition api-admin-task \
            --query taskDefinition > current-task-def.json
          
          # ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë¡¤ë°± ëŒ€ìƒìœ¼ë¡œ ë³€ê²½
          jq '.containerDefinitions[0].image = "${{ steps.login-ecr.outputs.registry }}/mini-shopping/api-admin:${{ github.event.inputs.commit_sha }}"' \
            current-task-def.json > new-task-def.json
          
          # ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±°
          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy, .enableFaultInjection)' \
            new-task-def.json > final-task-def.json
          
          # ìƒˆë¡œìš´ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          echo "ğŸ“ ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡ ì¤‘..."
          TASK_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://final-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          
          echo "âœ… ìƒˆ íƒœìŠ¤í¬ ì •ì˜: $TASK_ARN"
          
          # ECS ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
          echo "ğŸš€ ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì¤‘..."
          aws ecs update-service \
            --cluster mini-shopping-cluster \
            --service api-admin-service \
            --task-definition $TASK_ARN \
            --force-new-deployment
          
          echo "âœ… api-admin ë¡¤ë°± ëª…ë ¹ ì™„ë£Œ (ë°°í¬ ì§„í–‰ ì¤‘)"

      # Step 9: GitHub Issue ìƒì„± (ë¡¤ë°± ê¸°ë¡)
      - name: Create rollback record issue
        if: success()  # ë¡¤ë°± ì„±ê³µ ì‹œì—ë§Œ ì‹¤í–‰
        uses: actions/github-script@v6
        with:
          script: |
            const issueTitle = `ğŸ”„ Rollback: ${context.payload.inputs.service} to ${context.payload.inputs.commit_sha.substring(0, 7)}`;
            const issueBody = `## ë¡¤ë°± ì •ë³´

            ### ê¸°ë³¸ ì •ë³´
            - **ì„œë¹„ìŠ¤:** ${context.payload.inputs.service}
            - **ëŒ€ìƒ ë²„ì „:** \`${context.payload.inputs.commit_sha}\`
            - **ë¡¤ë°± ì‚¬ìœ :** ${context.payload.inputs.reason}
            - **ì‹¤í–‰ì:** @${context.actor}
            - **ì‹¤í–‰ ì‹œê°„:** ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })} (KST)
            
            ### ë¡¤ë°± ê²°ê³¼
            - **ìƒíƒœ:** âœ… ì„±ê³µ
            - **GitHub Actions ë§í¬:** [Run #${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### ë‹¤ìŒ ë‹¨ê³„
            1. ECS ì½˜ì†”ì—ì„œ ë°°í¬ ì™„ë£Œ í™•ì¸ (ì•½ 2-5ë¶„ ì†Œìš”)
            2. í—¬ìŠ¤ì²´í¬ ë° ëª¨ë‹ˆí„°ë§ í™•ì¸
            3. ë¬¸ì œ ì›ì¸ ë¶„ì„ ë° ìˆ˜ì •
            4. ìˆ˜ì • í›„ ì¬ë°°í¬ ê³„íš ìˆ˜ë¦½
            
            ### ìœ ìš©í•œ ëª…ë ¹ì–´
            \`\`\`bash
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            aws ecs describe-services --cluster mini-shopping-cluster --services ${context.payload.inputs.service}-service --query 'services[0].deployments'
            
            # ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ í™•ì¸
            aws ecs list-tasks --cluster mini-shopping-cluster --service ${context.payload.inputs.service}-service
            \`\`\`
            
            ---
            
            cc: @${context.actor}
            `;
            
            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['rollback', 'production', context.payload.inputs.service]
              });
            
              console.log(`âœ… ë¡¤ë°± ê¸°ë¡ ì´ìŠˆ ìƒì„± ì™„ë£Œ: #${issue.data.number}`);
            } catch (error) {
              console.log('âš ï¸ ì´ìŠˆ ìƒì„± ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ):', error.message);
              console.log('ë¡¤ë°±ì€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

      # Step 10: ìµœì¢… ìš”ì•½
      - name: Summary
        if: always()
        run: |
          echo "## ğŸ“‹ ë¡¤ë°± ìš”ì•½"
          echo "================================"
          echo "- ì„œë¹„ìŠ¤: ${{ github.event.inputs.service }}"
          echo "- ëŒ€ìƒ ë²„ì „: ${{ github.event.inputs.commit_sha }}"
          echo "- ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          echo "- ì‹¤í–‰ì: ${{ github.actor }}"
          echo "- ìƒíƒœ: ${{ job.status }}"
          echo "================================"
          echo ""
          echo "ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. AWS ECS ì½˜ì†”ì—ì„œ ë°°í¬ ì§„í–‰ ìƒí™© í™•ì¸"
          echo "2. CloudWatch ë¡œê·¸ ëª¨ë‹ˆí„°ë§"
          echo "3. ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ í™•ì¸"
          echo ""
          echo "ğŸ”— ìœ ìš©í•œ ë§í¬:"
          echo "- ECS ì½˜ì†”: https://console.aws.amazon.com/ecs/home?region=ap-northeast-2"
          echo "- CloudWatch: https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-2"
          
          

#      # Slack ì•Œë¦¼ (Slack Webhook URLì´ ìˆëŠ” ê²½ìš°)
#      - name: Send Slack notification
#        if: always() && env.SLACK_WEBHOOK_URL != ''
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#        run: |
#          STATUS="${{ job.status }}"
#          COLOR="danger"
#          if [ "$STATUS" == "success" ]; then
#            COLOR="good"
#          fi
#
#          curl -X POST $SLACK_WEBHOOK_URL \
#            -H 'Content-type: application/json' \
#            -d '{
#              "attachments": [{
#                "color": "'$COLOR'",
#                "title": "ğŸ”„ ECS ë¡¤ë°± '$STATUS'",
#                "fields": [
#                  {"title": "ì„œë¹„ìŠ¤", "value": "'${{ github.event.inputs.service }}'", "short": true},
#                  {"title": "ëŒ€ìƒ ë²„ì „", "value": "'${{ github.event.inputs.commit_sha }}'", "short": true},
#                  {"title": "ì‚¬ìœ ", "value": "'${{ github.event.inputs.reason }}'", "short": false},
#                  {"title": "ì‹¤í–‰ì", "value": "'${{ github.actor }}'", "short": true},
#                  {"title": "ì‹œê°„", "value": "'$(date +'%Y-%m-%d %H:%M:%S KST')'", "short": true}
#                ]
#              }]
#            }'