name: Scale ECS Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'ìŠ¤ì¼€ì¼ë§í•  ì„œë¹„ìŠ¤ ì„ íƒ'
        required: true
        type: choice
        options:
          - api-user
          - api-admin
          - both
      reason:
        description: 'ìŠ¤ì¼€ì¼ë§/ì¬ì‹œì‘ ì‚¬ìœ '
        required: true
        type: string
      force_new_deployment:
        description: 'ì»¨í…Œì´ë„ˆ ê°•ì œ ì¬ì‹œì‘ (ê¸°ë³¸: true)'
        required: false
        type: boolean
        default: true
      desired_count:
        description: 'ì›í•˜ëŠ” íƒœìŠ¤í¬ ìˆ˜ (ë¹„ì›Œë‘ë©´ í˜„ì¬ ì„¤ì • ìœ ì§€)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  issues: write

env:
  AWS_REGION: 'ap-northeast-2'

jobs:
  # í˜„ì¬ ìƒíƒœ ìˆ˜ì§‘
  collect-current-state:
    name: Collect Current State
    runs-on: ubuntu-latest
    outputs:
      user-current-tag: ${{ steps.get-versions.outputs.user-tag }}
      user-current-digest: ${{ steps.get-versions.outputs.user-digest }}
      user-current-count: ${{ steps.get-versions.outputs.user-count }}
      admin-current-tag: ${{ steps.get-versions.outputs.admin-tag }}
      admin-current-digest: ${{ steps.get-versions.outputs.admin-digest }}
      admin-current-count: ${{ steps.get-versions.outputs.admin-count }}
    steps:
      # AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # í˜„ì¬ ë²„ì „ ì •ë³´ ìˆ˜ì§‘
      - name: Get current versions
        id: get-versions
        run: |
          echo "ğŸ“Š í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # api-user ì •ë³´ ìˆ˜ì§‘
          if [[ "${{ github.event.inputs.service }}" == "api-user" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            # ì„œë¹„ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            SERVICE_INFO=$(aws ecs describe-services \
              --cluster mini-shopping-cluster \
              --services api-user-service \
              --query 'services[0]' \
              --output json)
          
            # íƒœìŠ¤í¬ ì •ì˜ ARN
            USER_TASK_DEF=$(echo $SERVICE_INFO | jq -r '.taskDefinition')
          
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ ìˆ˜
            USER_RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.runningCount')
            USER_DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.desiredCount')
          
            # íƒœìŠ¤í¬ ì •ì˜ì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ì¶”ì¶œ
            USER_IMAGE=$(aws ecs describe-task-definition \
              --task-definition $USER_TASK_DEF \
              --query 'taskDefinition.containerDefinitions[0].image' \
              --output text)
          
            USER_TAG=$(echo $USER_IMAGE | awk -F':' '{print $NF}')
          
            # ECRì—ì„œ ë‹¤ì´ì œìŠ¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            USER_DIGEST=$(aws ecr describe-images \
              --repository-name mini-shopping/api-user \
              --image-ids imageTag=$USER_TAG \
              --query 'imageDetails[0].imageDigest' \
              --output text 2>/dev/null || echo "N/A")
          
            echo "user-tag=$USER_TAG" >> $GITHUB_OUTPUT
            echo "user-digest=$USER_DIGEST" >> $GITHUB_OUTPUT
            echo "user-count=$USER_DESIRED_COUNT" >> $GITHUB_OUTPUT
          
            echo "âœ… api-user í˜„ì¬ ìƒíƒœ:"
            echo "   - ë²„ì „: $USER_TAG"
            echo "   - ì‹¤í–‰ ì¤‘: $USER_RUNNING_COUNT / ì›í•˜ëŠ” ìˆ˜: $USER_DESIRED_COUNT"
          else
            echo "user-tag=N/A" >> $GITHUB_OUTPUT
            echo "user-digest=N/A" >> $GITHUB_OUTPUT
            echo "user-count=N/A" >> $GITHUB_OUTPUT
          fi
          
          # api-admin ì •ë³´ ìˆ˜ì§‘
          if [[ "${{ github.event.inputs.service }}" == "api-admin" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            # ì„œë¹„ìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            SERVICE_INFO=$(aws ecs describe-services \
              --cluster mini-shopping-cluster \
              --services api-admin-service \
              --query 'services[0]' \
              --output json)
          
            # íƒœìŠ¤í¬ ì •ì˜ ARN
            ADMIN_TASK_DEF=$(echo $SERVICE_INFO | jq -r '.taskDefinition')
          
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬ ìˆ˜
            ADMIN_RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.runningCount')
            ADMIN_DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.desiredCount')
          
            # íƒœìŠ¤í¬ ì •ì˜ì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ì¶”ì¶œ
            ADMIN_IMAGE=$(aws ecs describe-task-definition \
              --task-definition $ADMIN_TASK_DEF \
              --query 'taskDefinition.containerDefinitions[0].image' \
              --output text)
          
            ADMIN_TAG=$(echo $ADMIN_IMAGE | awk -F':' '{print $NF}')
          
            # ECRì—ì„œ ë‹¤ì´ì œìŠ¤íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            ADMIN_DIGEST=$(aws ecr describe-images \
              --repository-name mini-shopping/api-admin \
              --image-ids imageTag=$ADMIN_TAG \
              --query 'imageDetails[0].imageDigest' \
              --output text 2>/dev/null || echo "N/A")
          
            echo "admin-tag=$ADMIN_TAG" >> $GITHUB_OUTPUT
            echo "admin-digest=$ADMIN_DIGEST" >> $GITHUB_OUTPUT
            echo "admin-count=$ADMIN_DESIRED_COUNT" >> $GITHUB_OUTPUT
          
            echo "âœ… api-admin í˜„ì¬ ìƒíƒœ:"
            echo "   - ë²„ì „: $ADMIN_TAG"
            echo "   - ì‹¤í–‰ ì¤‘: $ADMIN_RUNNING_COUNT / ì›í•˜ëŠ” ìˆ˜: $ADMIN_DESIRED_COUNT"
          else
            echo "admin-tag=N/A" >> $GITHUB_OUTPUT
            echo "admin-digest=N/A" >> $GITHUB_OUTPUT
            echo "admin-count=N/A" >> $GITHUB_OUTPUT
          fi

  # ì¬ë°°í¬ ì‹¤í–‰
  redeploy:
    name: Redeploy Services
    needs: collect-current-state
    runs-on: ubuntu-latest
    outputs:
      redeploy-success: ${{ steps.wait-deployment.outputs.success }}
      user-redeployed: ${{ steps.execute-redeploy.outputs.user_redeployed }}
      admin-redeployed: ${{ steps.execute-redeploy.outputs.admin_redeployed }}
      user-new-count: ${{ steps.execute-redeploy.outputs.user_new_count }}
      admin-new-count: ${{ steps.execute-redeploy.outputs.admin_new_count }}
    steps:
      # AWS ì¸ì¦
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ì¬ë°°í¬ ì¶”ì  ì´ˆê¸°í™”
      - name: Initialize redeploy tracking
        id: track-redeploy
        run: |
          echo "user_redeployed=false" >> $GITHUB_OUTPUT
          echo "admin_redeployed=false" >> $GITHUB_OUTPUT
          echo "user_new_count=${{ needs.collect-current-state.outputs.user-current-count }}" >> $GITHUB_OUTPUT
          echo "admin_new_count=${{ needs.collect-current-state.outputs.admin-current-count }}" >> $GITHUB_OUTPUT

      # ì¬ë°°í¬ ì‹¤í–‰
      - name: Execute redeploy
        id: execute-redeploy
        run: |
          echo "ğŸ”„ ì¬ë°°í¬ ì‹œì‘..."
          
          # ì¬ë°°í¬ ì‹¤í–‰ í•¨ìˆ˜
          redeploy_service() {
            local SERVICE_NAME=$1
            local DESIRED_COUNT=$2
          
            echo "ğŸš€ $SERVICE_NAME ì¬ë°°í¬ ì¤‘..."
          
            # ê¸°ë³¸ ì—…ë°ì´íŠ¸ ëª…ë ¹ êµ¬ì„±
            UPDATE_CMD="aws ecs update-service \
              --cluster mini-shopping-cluster \
              --service $SERVICE_NAME"
          
            # ê°•ì œ ìƒˆ ë°°í¬ ì˜µì…˜
            if [[ "${{ github.event.inputs.force_new_deployment }}" == "true" ]]; then
              UPDATE_CMD="$UPDATE_CMD --force-new-deployment"
            fi
          
            # ì›í•˜ëŠ” íƒœìŠ¤í¬ ìˆ˜ê°€ ì§€ì •ëœ ê²½ìš°
            if [[ ! -z "$DESIRED_COUNT" ]]; then
              UPDATE_CMD="$UPDATE_CMD --desired-count $DESIRED_COUNT"
              echo "   íƒœìŠ¤í¬ ìˆ˜ ë³€ê²½: $DESIRED_COUNT"
            fi
          
            # ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤í–‰
            if eval $UPDATE_CMD > /dev/null 2>&1; then
              echo "âœ… $SERVICE_NAME ì¬ë°°í¬ ì‹œì‘ë¨"
              return 0
            else
              echo "âŒ $SERVICE_NAME ì¬ë°°í¬ ì‹¤íŒ¨"
              return 1
            fi
          }
          
          # ì¬ë°°í¬ ìƒíƒœë¥¼ ì €ì¥í•  ë³€ìˆ˜
          USER_REDEPLOYED="false"
          ADMIN_REDEPLOYED="false"
          USER_NEW_COUNT="${{ needs.collect-current-state.outputs.user-current-count }}"
          ADMIN_NEW_COUNT="${{ needs.collect-current-state.outputs.admin-current-count }}"
          
          # api-user ì¬ë°°í¬
          if [[ "${{ github.event.inputs.service }}" == "api-user" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            # ì›í•˜ëŠ” íƒœìŠ¤í¬ ìˆ˜ ê²°ì •
            if [[ ! -z "${{ github.event.inputs.desired_count }}" ]]; then
              USER_DESIRED_COUNT="${{ github.event.inputs.desired_count }}"
              USER_NEW_COUNT="$USER_DESIRED_COUNT"
            else
              USER_DESIRED_COUNT=""
            fi
          
            if redeploy_service "api-user-service" "$USER_DESIRED_COUNT"; then
              USER_REDEPLOYED="true"
            fi
          fi
          
          # api-admin ì¬ë°°í¬
          if [[ "${{ github.event.inputs.service }}" == "api-admin" ]] || [[ "${{ github.event.inputs.service }}" == "both" ]]; then
            # ì›í•˜ëŠ” íƒœìŠ¤í¬ ìˆ˜ ê²°ì •
            if [[ ! -z "${{ github.event.inputs.desired_count }}" ]]; then
              ADMIN_DESIRED_COUNT="${{ github.event.inputs.desired_count }}"
              ADMIN_NEW_COUNT="$ADMIN_DESIRED_COUNT"
            else
              ADMIN_DESIRED_COUNT=""
            fi
          
            if redeploy_service "api-admin-service" "$ADMIN_DESIRED_COUNT"; then
              ADMIN_REDEPLOYED="true"
            fi
          fi
          
          # GitHub Actions outputsì— ì§ì ‘ ì €ì¥
          echo "user_redeployed=$USER_REDEPLOYED" >> $GITHUB_OUTPUT
          echo "admin_redeployed=$ADMIN_REDEPLOYED" >> $GITHUB_OUTPUT
          echo "user_new_count=$USER_NEW_COUNT" >> $GITHUB_OUTPUT
          echo "admin_new_count=$ADMIN_NEW_COUNT" >> $GITHUB_OUTPUT

      # ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
      - name: Wait for deployment
        id: wait-deployment
        run: |
          echo "â³ ì¬ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          
          wait_for_service() {
            local service=$1
            local max_attempts=40
            local attempt=0
          
            while [ $attempt -lt $max_attempts ]; do
              # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
              SERVICE_STATE=$(aws ecs describe-services \
                --cluster mini-shopping-cluster \
                --services $service \
                --query 'services[0]' \
                --output json)
          
              # ë°°í¬ ìƒíƒœ í™•ì¸
              DEPLOYMENT_COUNT=$(echo $SERVICE_STATE | jq '.deployments | length')
              PRIMARY_DEPLOYMENT=$(echo $SERVICE_STATE | jq -r '.deployments[] | select(.status == "PRIMARY")')
          
              # ë°°í¬ê°€ í•˜ë‚˜ë§Œ ìˆê³  PRIMARY ìƒíƒœë©´ ì™„ë£Œ
              if [ "$DEPLOYMENT_COUNT" -eq 1 ] && [ ! -z "$PRIMARY_DEPLOYMENT" ]; then
                RUNNING_COUNT=$(echo $PRIMARY_DEPLOYMENT | jq -r '.runningCount')
                DESIRED_COUNT=$(echo $PRIMARY_DEPLOYMENT | jq -r '.desiredCount')
          
                if [ "$RUNNING_COUNT" -eq "$DESIRED_COUNT" ]; then
                  echo "âœ… $service ì¬ë°°í¬ ì™„ë£Œ (ì‹¤í–‰ ì¤‘: $RUNNING_COUNT)"
                  return 0
                fi
              fi
          
              echo "â³ ëŒ€ê¸° ì¤‘... (ë°°í¬: $DEPLOYMENT_COUNTê°œ)"
              sleep 15
              ((attempt++))
            done
          
            echo "âŒ $service ì¬ë°°í¬ ì‹œê°„ ì´ˆê³¼"
            return 1
          }
          
          SUCCESS="true"
          
          # ì¬ë°°í¬ëœ ì„œë¹„ìŠ¤ë§Œ ëŒ€ê¸°
          if [[ "${{ steps.execute-redeploy.outputs.user_redeployed }}" == "true" ]]; then
            wait_for_service "api-user-service" || SUCCESS="false"
          fi
          
          if [[ "${{ steps.execute-redeploy.outputs.admin_redeployed }}" == "true" ]]; then
            wait_for_service "api-admin-service" || SUCCESS="false"
          fi
          
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT

  # ì¬ë°°í¬ í›„ ìƒíƒœ ìˆ˜ì§‘
  collect-post-state:
    name: Collect Post-Deployment State
    needs: redeploy
    if: needs.redeploy.outputs.redeploy-success == 'true'
    runs-on: ubuntu-latest
    outputs:
      user-final-tag: ${{ steps.get-final-versions.outputs.user-tag }}
      user-final-count: ${{ steps.get-final-versions.outputs.user-count }}
      user-running-count: ${{ steps.get-final-versions.outputs.user-running }}
      admin-final-tag: ${{ steps.get-final-versions.outputs.admin-tag }}
      admin-final-count: ${{ steps.get-final-versions.outputs.admin-count }}
      admin-running-count: ${{ steps.get-final-versions.outputs.admin-running }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get final versions
        id: get-final-versions
        run: |
          echo "ğŸ“Š ì¬ë°°í¬ í›„ ìµœì¢… ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # api-user ìµœì¢… ìƒíƒœ
          if [[ "${{ needs.redeploy.outputs.user-redeployed }}" == "true" ]]; then
            SERVICE_INFO=$(aws ecs describe-services \
              --cluster mini-shopping-cluster \
              --services api-user-service \
              --query 'services[0]' \
              --output json)
          
            USER_TASK_DEF=$(echo $SERVICE_INFO | jq -r '.taskDefinition')
            USER_DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.desiredCount')
            USER_RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.runningCount')
          
            USER_IMAGE=$(aws ecs describe-task-definition \
              --task-definition $USER_TASK_DEF \
              --query 'taskDefinition.containerDefinitions[0].image' \
              --output text)
          
            USER_TAG=$(echo $USER_IMAGE | awk -F':' '{print $NF}')
          
            echo "user-tag=$USER_TAG" >> $GITHUB_OUTPUT
            echo "user-count=$USER_DESIRED_COUNT" >> $GITHUB_OUTPUT
            echo "user-running=$USER_RUNNING_COUNT" >> $GITHUB_OUTPUT
          else
            echo "user-tag=N/A" >> $GITHUB_OUTPUT
            echo "user-count=N/A" >> $GITHUB_OUTPUT
            echo "user-running=N/A" >> $GITHUB_OUTPUT
          fi
          
          # api-admin ìµœì¢… ìƒíƒœ
          if [[ "${{ needs.redeploy.outputs.admin-redeployed }}" == "true" ]]; then
            SERVICE_INFO=$(aws ecs describe-services \
              --cluster mini-shopping-cluster \
              --services api-admin-service \
              --query 'services[0]' \
              --output json)
          
            ADMIN_TASK_DEF=$(echo $SERVICE_INFO | jq -r '.taskDefinition')
            ADMIN_DESIRED_COUNT=$(echo $SERVICE_INFO | jq -r '.desiredCount')
            ADMIN_RUNNING_COUNT=$(echo $SERVICE_INFO | jq -r '.runningCount')
          
            ADMIN_IMAGE=$(aws ecs describe-task-definition \
              --task-definition $ADMIN_TASK_DEF \
              --query 'taskDefinition.containerDefinitions[0].image' \
              --output text)
          
            ADMIN_TAG=$(echo $ADMIN_IMAGE | awk -F':' '{print $NF}')
          
            echo "admin-tag=$ADMIN_TAG" >> $GITHUB_OUTPUT
            echo "admin-count=$ADMIN_DESIRED_COUNT" >> $GITHUB_OUTPUT
            echo "admin-running=$ADMIN_RUNNING_COUNT" >> $GITHUB_OUTPUT
          else
            echo "admin-tag=N/A" >> $GITHUB_OUTPUT
            echo "admin-count=N/A" >> $GITHUB_OUTPUT
            echo "admin-running=N/A" >> $GITHUB_OUTPUT
          fi

  # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
  create-release:
    name: Create Redeploy Release
    needs: [collect-current-state, redeploy, collect-post-state]
    if: needs.redeploy.outputs.redeploy-success == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # í˜„ì¬ ì‹œê°„
      - name: Get current date
        id: date
        run: |
          echo "date=$(TZ=Asia/Seoul date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "timestamp=$(TZ=Asia/Seoul date +'%Y%m%d%H%M%S')" >> $GITHUB_OUTPUT

      # ë¦´ë¦¬ì¦ˆ ìƒì„±
      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: redeploy-${{ steps.date.outputs.timestamp }}
          name: Redeploy ${{ github.run_number }}
          body: |
            ## ğŸ”„ ì¬ë°°í¬ ì™„ë£Œ
            
            ### ì¬ë°°í¬ ì •ë³´
            - **ì¬ë°°í¬ ì‹œê°„:** ${{ steps.date.outputs.datetime }} (KST)
            - **ì¬ë°°í¬ ëŒ€ìƒ:** ${{ github.event.inputs.service }}
            - **ì¬ë°°í¬ ì‚¬ìœ :** ${{ github.event.inputs.reason }}
            - **ê°•ì œ ìƒˆ ë°°í¬:** ${{ github.event.inputs.force_new_deployment }}
            ${{ github.event.inputs.desired_count && format('- **ìš”ì²­ëœ íƒœìŠ¤í¬ ìˆ˜:** {0}', github.event.inputs.desired_count) || '' }}
            
            ### ì¬ë°°í¬ëœ ì„œë¹„ìŠ¤
            - **api-user:** ${{ needs.redeploy.outputs.user-redeployed == 'true' && 'ğŸ”„ ì¬ë°°í¬ë¨' || 'â­ï¸ ìŠ¤í‚µ' }}
              - ë²„ì „: `${{ needs.collect-current-state.outputs.user-current-tag }}` (ë³€ê²½ ì—†ìŒ)
              - íƒœìŠ¤í¬ ìˆ˜: ${{ needs.collect-current-state.outputs.user-current-count }} â†’ ${{ needs.redeploy.outputs.user-new-count }}
              - **ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬:** ${{ needs.collect-post-state.outputs.user-running-count }} / ${{ needs.collect-post-state.outputs.user-final-count }}
              - Digest: `${{ needs.collect-current-state.outputs.user-current-digest }}`
            
            - **api-admin:** ${{ needs.redeploy.outputs.admin-redeployed == 'true' && 'ğŸ”„ ì¬ë°°í¬ë¨' || 'â­ï¸ ìŠ¤í‚µ' }}
              - ë²„ì „: `${{ needs.collect-current-state.outputs.admin-current-tag }}` (ë³€ê²½ ì—†ìŒ)
              - íƒœìŠ¤í¬ ìˆ˜: ${{ needs.collect-current-state.outputs.admin-current-count }} â†’ ${{ needs.redeploy.outputs.admin-new-count }}
              - **ì‹¤í–‰ ì¤‘ì¸ íƒœìŠ¤í¬:** ${{ needs.collect-post-state.outputs.admin-running-count }} / ${{ needs.collect-post-state.outputs.admin-final-count }}
              - Digest: `${{ needs.collect-current-state.outputs.admin-current-digest }}`
            
            ### ì‹¤í–‰ ì •ë³´
            - **ì‹¤í–‰ì:** @${{ github.actor }}
            - **ë°°í¬ í™˜ê²½:** Production
            - **Actions ë§í¬:** [Run #${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            > â„¹ï¸ **ì°¸ê³ **: ì´ ë¦´ë¦¬ì¦ˆëŠ” ë²„ì „ ë³€ê²½ ì—†ì´ ì¬ë°°í¬ë§Œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ì¬ë°°í¬ ì´ìŠˆ ìƒì„±
  create-issue:
    name: Create Redeploy Issue
    needs: [collect-current-state, redeploy, collect-post-state, create-release]
    if: needs.redeploy.outputs.redeploy-success == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # í˜„ì¬ ì‹œê°„
      - name: Get current date
        id: date
        run: |
          echo "datetime=$(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # ì´ìŠˆ ìƒì„±
      - name: Create issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueTitle = `ğŸ”„ ì¬ë°°í¬ ì™„ë£Œ: ${context.payload.inputs.service} - ${new Date().toISOString().split('T')[0]}`;
            
            let redeployDetails = [];
            
            // ì¬ë°°í¬ëœ ì„œë¹„ìŠ¤ ì •ë³´
            if ('${{ needs.redeploy.outputs.user-redeployed }}' === 'true') {
              const taskCountChange = '${{ needs.collect-current-state.outputs.user-current-count }}' !== '${{ needs.redeploy.outputs.user-new-count }}' 
                ? ` (íƒœìŠ¤í¬ ìˆ˜: ${{ needs.collect-current-state.outputs.user-current-count }} â†’ ${{ needs.redeploy.outputs.user-new-count }})` 
                : '';
              redeployDetails.push(`- **api-user**: \`${{ needs.collect-current-state.outputs.user-current-tag }}\` (ë²„ì „ ë³€ê²½ ì—†ìŒ)${taskCountChange}`);
            }
            
            if ('${{ needs.redeploy.outputs.admin-redeployed }}' === 'true') {
              const taskCountChange = '${{ needs.collect-current-state.outputs.admin-current-count }}' !== '${{ needs.redeploy.outputs.admin-new-count }}' 
                ? ` (íƒœìŠ¤í¬ ìˆ˜: ${{ needs.collect-current-state.outputs.admin-current-count }} â†’ ${{ needs.redeploy.outputs.admin-new-count }})` 
                : '';
              redeployDetails.push(`- **api-admin**: \`${{ needs.collect-current-state.outputs.admin-current-tag }}\` (ë²„ì „ ë³€ê²½ ì—†ìŒ)${taskCountChange}`);
            }
            
            const issueBody = `## ì¬ë°°í¬ ìƒì„¸ ì •ë³´
            
            ### ê¸°ë³¸ ì •ë³´
            - **ì¬ë°°í¬ ì‹œê°„**: ${{ steps.date.outputs.datetime }} (KST)
            - **ì¬ë°°í¬ ì‹¤í–‰ì**: @${{ github.actor }}
            - **ì¬ë°°í¬ ëŒ€ìƒ**: ${{ github.event.inputs.service }}
            - **ì¬ë°°í¬ ì‚¬ìœ **: ${{ github.event.inputs.reason }}
            - **ê°•ì œ ìƒˆ ë°°í¬**: ${{ github.event.inputs.force_new_deployment }}
            ${context.payload.inputs.desired_count ? `- **ìš”ì²­ëœ íƒœìŠ¤í¬ ìˆ˜**: ${context.payload.inputs.desired_count}` : ''}
            
            ### ì¬ë°°í¬ëœ ì„œë¹„ìŠ¤
            ${redeployDetails.length > 0 ? redeployDetails.join('\n') : '- ì¬ë°°í¬ëœ ì„œë¹„ìŠ¤ ì—†ìŒ'}
            
            ### ê´€ë ¨ ë§í¬
            - [Actions Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸](https://github.com/${{ github.repository }}/releases/latest)
            
            ### ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘ í™•ì¸
            - [ ] ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ í™•ì¸
            - [ ] ë¡œê·¸ ëª¨ë‹ˆí„°ë§
            - [ ] ì„±ëŠ¥ ì§€í‘œ í™•ì¸
            
            ### ì¬ë°°í¬ íƒ€ì…
            - **ë²„ì „ ë³€ê²½**: âŒ ì—†ìŒ
            - **ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘**: âœ… ìˆ˜í–‰ë¨
            - **ì„¤ì • ë³€ê²½**: ${{ github.event.inputs.force_new_deployment == 'true' && 'âœ… ê°•ì œ ìƒˆ ë°°í¬' || 'âŒ ì¼ë°˜ ì¬ë°°í¬' }}
            
            ---
            
            > ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['redeploy', 'production', 'automated'],
              assignees: ['${{ github.actor }}']
            });
            
            console.log(`Issue created: ${issue.data.html_url}`);